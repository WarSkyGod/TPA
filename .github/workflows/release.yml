name: è‡ªåŠ¨æ„å»ºä¸å‘å¸ƒ

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è·å–é¡¹ç›®ä¿¡æ¯
        id: project-info
        run: |
          # è·å–é¡¹ç›®åç§°ï¼ˆä¼˜å…ˆä½¿ç”¨<name>æ ‡ç­¾ï¼‰
          PROJECT_NAME=$(mvn help:evaluate -Dexpression=project.name -q -DforceStdout | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
          if [ "$PROJECT_NAME" = "null" ]; then
            PROJECT_NAME=$(mvn help:evaluate -Dexpression=project.artifactId -q -DforceStdout)
          fi
          
          # è·å–å¹¶æ¸…ç†ç‰ˆæœ¬å·
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout | tr -d '\n')
          
          echo "name=${PROJECT_NAME}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: è®¾ç½®JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Mavenæ„å»º
        run: mvn -B clean package

      - name: è·å–æäº¤ä¿¡æ¯
        id: get-commit
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:%B)
          echo "commit_msg<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: è®¡ç®—æ–‡ä»¶å“ˆå¸Œ
        id: file-hashes
        run: |
          echo "## ğŸ“¦ æ–‡ä»¶æ ¡éªŒå“ˆå¸Œ" > hashes.md
          echo '```' >> hashes.md
          
          for file in target/*.jar; do
            if [ -f "$file" ]; then
              hash=$(sha256sum "$file" | awk '{print \$1}')
              filename=$(basename "$file")
              echo "${filename}: ${hash}" >> hashes.md
            fi
          done
          
          echo '```' >> hashes.md
          echo "hash_content<<EOF" >> $GITHUB_OUTPUT
          cat hashes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: è·å–æ„å»ºæ—¶é—´
        id: get-date
        run: |
          echo "date=$(date +'%Yå¹´%mæœˆ%dæ—¥ %Hæ—¶%Måˆ†%Sç§’')" >> $GITHUB_OUTPUT

      - name: åˆ›å»ºRelease
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.project-info.outputs.version }}
          name: ${{ steps.project-info.outputs.name }}-v${{ steps.project-info.outputs.version }}
          body: |
            ## ğŸ“ æœ€æ–°æäº¤ä¿¡æ¯
            ```
            ${{ steps.get-commit.outputs.commit_msg }}
            ```

            ## ğŸ”¨ æ„å»ºè¯¦æƒ…
            - **é¡¹ç›®åç§°**: ${{ steps.project-info.outputs.name }}
            - **ç‰ˆæœ¬å·**: ${{ steps.project-info.outputs.version }}
            - **æ¥æºæäº¤**: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            - **ç¼–è¯‘æ—¶é—´**: ${{ steps.get-date.outputs.date }}

            ${{ steps.file-hashes.outputs.hash_content }}

            > ğŸš€ æœ¬ Release ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ
          files: |
            target/*.jar
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
